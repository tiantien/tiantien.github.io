<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>StateFulSet | Tiantien的个人主页</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/images/icon.jpg">
    <meta name="description" content="工作 生活 成长">
    
    <link rel="preload" href="/assets/css/0.styles.2ed08540.css" as="style"><link rel="preload" href="/assets/js/app.bcfbac2f.js" as="script"><link rel="preload" href="/assets/js/2.883ec247.js" as="script"><link rel="preload" href="/assets/js/38.c5744899.js" as="script"><link rel="preload" href="/assets/js/3.314a3542.js" as="script"><link rel="prefetch" href="/assets/js/10.6e365f99.js"><link rel="prefetch" href="/assets/js/11.eb0a9c06.js"><link rel="prefetch" href="/assets/js/12.7ccff92d.js"><link rel="prefetch" href="/assets/js/13.1a676209.js"><link rel="prefetch" href="/assets/js/14.84569625.js"><link rel="prefetch" href="/assets/js/15.64620e76.js"><link rel="prefetch" href="/assets/js/16.dcd106a3.js"><link rel="prefetch" href="/assets/js/17.4487984b.js"><link rel="prefetch" href="/assets/js/18.df3b341b.js"><link rel="prefetch" href="/assets/js/19.bb69705a.js"><link rel="prefetch" href="/assets/js/20.a0db47c5.js"><link rel="prefetch" href="/assets/js/21.13f70884.js"><link rel="prefetch" href="/assets/js/22.5c3133e9.js"><link rel="prefetch" href="/assets/js/23.01458c00.js"><link rel="prefetch" href="/assets/js/24.d4a9db68.js"><link rel="prefetch" href="/assets/js/25.998e0adb.js"><link rel="prefetch" href="/assets/js/26.25418bff.js"><link rel="prefetch" href="/assets/js/27.8ff41d05.js"><link rel="prefetch" href="/assets/js/28.cdff56fe.js"><link rel="prefetch" href="/assets/js/29.d1db752c.js"><link rel="prefetch" href="/assets/js/30.c677a34a.js"><link rel="prefetch" href="/assets/js/31.c2809115.js"><link rel="prefetch" href="/assets/js/32.dc7e67b3.js"><link rel="prefetch" href="/assets/js/33.cd1f8225.js"><link rel="prefetch" href="/assets/js/34.2151e4cd.js"><link rel="prefetch" href="/assets/js/35.745f43c6.js"><link rel="prefetch" href="/assets/js/36.9bf3793c.js"><link rel="prefetch" href="/assets/js/37.63810e6d.js"><link rel="prefetch" href="/assets/js/39.3da71ecf.js"><link rel="prefetch" href="/assets/js/4.f16064d6.js"><link rel="prefetch" href="/assets/js/40.46937a01.js"><link rel="prefetch" href="/assets/js/41.ffd7badc.js"><link rel="prefetch" href="/assets/js/42.393b38f0.js"><link rel="prefetch" href="/assets/js/43.b13514ee.js"><link rel="prefetch" href="/assets/js/44.5cf1c803.js"><link rel="prefetch" href="/assets/js/5.952f3482.js"><link rel="prefetch" href="/assets/js/6.2901a65d.js"><link rel="prefetch" href="/assets/js/7.dee35a8b.js"><link rel="prefetch" href="/assets/js/8.c81aeacd.js"><link rel="prefetch" href="/assets/js/9.64f79a1d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2ed08540.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/icon.jpg" alt="Tiantien的个人主页" class="logo"> <span class="site-name can-hide">Tiantien的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/todo/" class="nav-link">
  TodoList
</a></div><div class="nav-item"><a href="/tree/vuepress/" class="nav-link">
  VuePress
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/todo/" class="nav-link">
  TodoList
</a></div><div class="nav-item"><a href="/tree/vuepress/" class="nav-link">
  VuePress
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/tree/k8s/k8s.html" class="sidebar-link">k8s概述</a></li><li><a href="/tree/k8s/configmap.html" class="sidebar-link">ConfigMap</a></li><li><a href="/tree/k8s/containerd.html" class="sidebar-link">Containerd</a></li><li><a href="/tree/k8s/deployment.html" class="sidebar-link">Deployment</a></li><li><a href="/tree/k8s/ingress.html" class="sidebar-link">Ingress</a></li><li><a href="/tree/k8s/namespace.html" class="sidebar-link">Namespace</a></li><li><a href="/tree/k8s/pod.html" class="sidebar-link">Pod</a></li><li><a href="/tree/k8s/secret.html" class="sidebar-link">Secret</a></li><li><a href="/tree/k8s/service.html" class="sidebar-link">Service</a></li><li><a href="/tree/k8s/statefulset.html" aria-current="page" class="active sidebar-link">Statefulset</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tree/k8s/statefulset.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/tree/k8s/statefulset.html#statefulset-使用场景" class="sidebar-link">StatefulSet 使用场景</a></li></ul></li><li><a href="/tree/k8s/持续化存储.html" class="sidebar-link">持续化存储</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="statefulset"><a href="#statefulset" class="header-anchor">#</a> StateFulSet</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>Deployment控制器下的Pod都有个共同特点，那就是每个Pod除了名称和IP地址不同，其余完全相同。需要的时候，Deployment可以通过Pod模板创建新的Pod；不需要的时候，Deployment就可以删除任意一个Pod。</p> <p>但是在某些场景下，这并不满足需求，比如有些分布式的场景，要求每个Pod都有自己单独的状态时，比如分布式数据库，每个Pod要求有单独的存储，这时Deployment就不能满足需求了。</p> <p>详细分析下有状态应用的需求，分布式有状态的特点主要是应用中每个部分的角色不同（即分工不同），比如数据库有主备，Pod之间有依赖，对应到Kubernetes中就是对Pod有如下要求：</p> <ul><li>Pod能够被别的Pod找到，这就要求Pod有固定的标识。</li> <li>每个Pod有单独存储，Pod被删除恢复后，读取的数据必须还是以前那份，否则状态就会不一致。</li></ul> <p>Kubernetes提供了StatefulSet来解决这个问题，其具体如下：</p> <ol><li>StatefulSet给每个Pod提供固定名称，Pod名称增加从0-N的固定后缀，Pod重新调度后Pod名称和HostName不变。</li> <li>StatefulSet通过Headless Service给每个Pod提供固定的访问域名，Service的概念会在后面章节中详细介绍。</li> <li>StatefulSet通过创建固定标识的PVC保证Pod重新调度后还是能访问到相同的持久化数据。</li></ol> <h2 id="statefulset-使用场景"><a href="#statefulset-使用场景" class="header-anchor">#</a> StatefulSet 使用场景</h2> <p>对于有如下要求的应用程序，StatefulSet 非常适用：</p> <ul><li>稳定、唯一的网络标识（dnsname）</li> <li>每个Pod始终对应各自的存储路径（PersistantVolumeClaimTemplate）</li> <li>按顺序地增加副本、减少副本，并在减少副本时执行清理</li> <li>按顺序自动地执行滚动更新</li></ul> <p>如果一个应用程序不需要稳定的网络标识，或者不需要按顺序部署、删除、增加副本，您应该考虑使用 Deployment 这类无状态（stateless）的控制器。</p> <h4 id="创建headless-service"><a href="#创建headless-service" class="header-anchor">#</a> 创建Headless Service</h4> <p>创建Statefulset需要一个Headless Service用于Pod访问</p> <h4 id="创建statefulset"><a href="#创建statefulset" class="header-anchor">#</a> 创建Statefulset</h4> <p>Statefulset的YAML定义与其他对象基本相同，主要有两个差异点：</p> <ul><li>serviceName指定了Statefulset使用哪个Headless Service，需要填写Headless Service的名称。</li> <li>volumeClaimTemplates是用来申请持久化声明<a href="https://support.huaweicloud.com/basics-cce/kubernetes_0030.html" target="_blank" rel="noopener noreferrer">PVC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这里定义了一个名为data的模板，它会为每个Pod创建一个PVC，storageClassName指定了持久化存储的类型，在<a href="https://support.huaweicloud.com/basics-cce/kubernetes_0030.html" target="_blank" rel="noopener noreferrer">PV、PVC和StorageClass<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>会详细介绍；volumeMounts是为Pod挂载存储。当然如果不需要存储的话可以删除volumeClaimTemplates和volumeMounts字段。</li></ul> <h4 id="statefulset的网络标识"><a href="#statefulset的网络标识" class="header-anchor">#</a> StatefulSet的网络标识</h4> <p>StatefulSet创建后，可以看下Pod是有固定名称的，那Headless Service是如何起作用的呢，那就是使用DNS，为Pod提供固定的域名，这样Pod间就可以使用域名访问，即便Pod被重新创建而导致Pod的IP地址发生变化，这个域名也不会发生变化。</p> <p>Headless Service创建后，每个Pod的IP都会有下面格式的域名。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>**&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local**

例如上面的三个Pod的域名就是：

- nginx-0.nginx.default.svc.cluster.local
- nginx-1.nginx.default.svc.cluster.local
- nginx-2.nginx.default.svc.cluster.local

实际访问时可以省略后面的**.&lt;namespace&gt;.svc.cluster.local**。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">nslookup</span> saber-db-0.saber-db
nslookup: can<span class="token string">'t resolve '</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span>': Name does not resolve

Name:      saber-db-0.saber-db
Address <span class="token number">1</span>: <span class="token number">100.64</span>.4.214 saber-db-0.saber-db.spring-blade.svc.cluster.local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="statefulset存储状态"><a href="#statefulset存储状态" class="header-anchor">#</a> StatefulSet存储状态</h4></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/18/2022, 12:34:13 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tree/k8s/service.html" class="prev">
        Service
      </a></span> <span class="next"><a href="/tree/k8s/持续化存储.html">
        持续化存储
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----></div></div>
    <script src="/assets/js/app.bcfbac2f.js" defer></script><script src="/assets/js/2.883ec247.js" defer></script><script src="/assets/js/38.c5744899.js" defer></script><script src="/assets/js/3.314a3542.js" defer></script>
  </body>
</html>
